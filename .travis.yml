stages:
  - name: test
  - name: deploy

env:
- PLATFROM=win-x64
- PLATFORM=linux-x64
- PLATFORM=osx-x64

matrix:
  exclude:
    - env: PLATFROM=win-x64
    - env: PLATFORM=linux-x64
    - env: PLATFORM=osx-x64

script: echo 'HERE'

jobs:
  include:
    - stage: test
      env: [PLATFORM=linux-x64]
      language: csharp
      mono: none
      dotnet: 2.1
      script:
        - cd ./test/UnitTests
        - dotnet restore
        - dotnet build
        - dotnet test
    - stage: deploy
      language: csharp
      mono: none
      dotnet: 2.1
      name: GitHub
      script:
        - dotnet publish ./src/App -r $PLATFORM /property:Version=$(cat .version) -o out
      deploy:
        provider: releases
        api_key: $GITHUB_OAUTH_TOKEN
        name: oas-$PLATFROM-$(cat .version)
        file_glob: true
        file: src/app/out/*
        skip_cleanup: true
    - stage: deploy
      language: node_js
      name: NPM
      script:
        - cd ./src/npm
        - npm install
        - npm test
        - npm version $(cat .version)
      deploy:
        provider: npm
        api_key: $NPM_API_KEY
        email: $NPM_EMAIL
